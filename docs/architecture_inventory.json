{
  "project": {
    "name": "dobaa",
    "last_updated": "2026-01-05",
    "type": "monolith",
    "runtime": {
      "backend": "node",
      "frontend": "static_unbundled_vanilla_js"
    },
    "entrypoints": {
      "backend": {
        "file": "index.js",
        "main": "app.listen(port, async () => { await scraper.init(); ... })"
      },
      "frontend": {
        "file": "public/index.html",
        "load_model": "script_tags_global_scope_order_matters"
      }
    },
    "dependencies": {
      "backend": [
        { "name": "express", "version_range": "^5.2.1" },
        { "name": "ws", "version_range": "^8.18.3" },
        { "name": "mongoose", "version_range": "^9.0.2" },
        { "name": "axios", "version_range": "^1.13.2" },
        { "name": "compression", "version_range": "^1.8.1" },
        { "name": "dotenv", "version_range": "^17.2.3" },
        { "name": "uuid", "version_range": "^13.0.0" }
      ],
      "dev": [
        { "name": "jest", "version_range": "^30.2.0" },
        { "name": "fast-check", "version_range": "^4.5.2" }
      ]
    },
    "config": {
      "env_vars": [
        { "name": "PORT", "required": false, "default": "3000", "used_in": ["index.js"] },
        { "name": "MONGODB_URI", "required": false, "default": null, "used_in": ["index.js", "lib/saveSportData.js", "routes/cached.js", "lib/statsProvider.js"] },
        { "name": "NODE_ENV", "required": false, "default": null, "used_in": ["index.js", "lib/admin.js"] },
        { "name": "ADMIN_KEY", "required": false, "default": null, "used_in": ["lib/admin.js", "routes/scrape.js", "routes/debug.js (some endpoints)"] },
        { "name": "DEBUG_PARSE_GAMES", "required": false, "default": "false", "used_in": ["lib/parseGamesFromData.js"] },
        { "name": "KROSSTATS_API_BASE_URL", "required": false, "default": "https://krosstats.betcoapps.com/api", "used_in": ["lib/statsProvider.js"] },
        { "name": "KROSSTATS_LANG", "required": false, "default": "en", "used_in": ["lib/statsProvider.js"] },
        { "name": "KROSSTATS_SITE_ID", "required": false, "default": null, "used_in": ["lib/statsProvider.js"], "notes": "Required to enable /api/game-stats. Can also be provided via Render Secret Files at /etc/secrets/KROSSTATS_SITE_ID" },
        { "name": "KROSSTATS_TOKEN", "required": false, "default": null, "used_in": ["lib/statsProvider.js"], "notes": "Required to enable /api/game-stats. Can also be provided via Render Secret Files at /etc/secrets/KROSSTATS_TOKEN" }
      ]
    }
  },
  "backend": {
    "server": {
      "framework": "express",
      "static_root": "public/",
      "middleware": [
        {
          "name": "compression",
          "factory": "createCompressionMiddleware",
          "file": "middleware/compression.js",
          "applied_in": "index.js",
          "notes": "Disabled for /api/live-tracker"
        },
        {
          "name": "response_timer",
          "factory": "createResponseTimerMiddleware",
          "file": "middleware/responseTimer.js",
          "applied_in": "index.js",
          "metrics_exposed_at": "/api/health"
        }
      ]
    },
    "services": {
      "ForzzaScraper": {
        "file": "scraper.js",
        "type": "websocket_client",
        "upstream": {
          "name": "Swarm API",
          "ws_url": "wss://eu-swarm-newm.vmemkhhgjigrjefb.com",
          "session_command": "request_session",
          "session_params": { "site_id": 1777, "language": "eng" }
        },
        "public_methods": [
          { "name": "init", "kind": "connect", "effects": ["opens_ws", "requests_session", "sets_sessionId", "starts_heartbeat_ping"] },
          { "name": "ensureConnection", "kind": "guard", "effects": ["reconnect_if_needed"] },
          { "name": "sendRequest", "kind": "rpc", "effects": ["writes_ws_message", "awaits_response_by_rid", "timeout_handling", "injects_sessionId"] },
          { "name": "getHierarchy", "kind": "domain", "effects": ["swarm_get_sport_region_competition", "unwrap", "retry_if_empty"] },
          { "name": "getGames", "kind": "domain", "effects": ["swarm_get_games_by_competition"] },
          { "name": "getGamesBySport", "kind": "domain", "effects": ["swarm_get_games_by_sport", "retry_on_empty", "fallback_no_type_filter"] },
          { "name": "getGameDetails", "kind": "domain", "effects": ["swarm_get_markets_events_by_game"] },
          { "name": "getActiveCompetitions", "kind": "domain", "effects": ["swarm_get_active_competitions_with_results"] },
          { "name": "getResultGames", "kind": "domain", "effects": ["swarm_get_result_games_by_sport"] },
          { "name": "getGameResults", "kind": "domain", "effects": ["swarm_get_results_settlements_by_game"] },
          { "name": "close", "kind": "cleanup", "effects": ["close_ws"] }
        ],
        "private_methods": [
          { "name": "subscribe", "kind": "domain", "effects": ["sends_subscribe_request", "handles_subid_response", "registers_update_listeners"] }
        ],
        "data_helpers": [
          { "name": "unwrapSwarmData", "file": "lib/swarm/unwrap.js", "used_by": ["scraper.js", "routes/liveStream.js", "routes/markets.js", "routes/debug.js", "lib/liveCounts/swarmCounts.js"] }
        ]
      },
      "Mongo": {
        "driver": "mongoose",
        "connection": { "env": "MONGODB_URI", "optional": true, "connected_in": "index.js" },
        "models": [
          {
            "name": "Game",
            "file": "models/Game.js",
            "schema": {
              "gameId": "Number(unique)",
              "sport": "String(index)",
              "type": "Number",
              "region": "String",
              "competition": "String",
              "team1_name": "String",
              "team2_name": "String",
              "team1_id": "Number",
              "team2_id": "Number",
              "start_ts": "Number",
              "market": "Object",
              "info": "Object",
              "last_updated": "Date(index)"
            },
            "indexes": [
              { "fields": ["sport", "last_updated"], "order": [1, -1] }
            ]
          }
        ],
        "query_layer": [
          {
            "name": "QueryOptimizer",
            "file": "utils/QueryOptimizer.js",
            "methods": [
              "getLatestGamesBySport",
              "getAllLatestGamesBySport",
              "getGameCount",
              "getLatestGameCount",
              "bulkUpsertGames",
              "findExactSportName",
              "getLatestCountsBySport",
              "getSportsWithAnyGames"
            ]
          }
        ]
      },
      "Caching": {
        "CacheManager": {
          "file": "utils/CacheManager.js",
          "used_for": [
            { "name": "hierarchy_cache", "ttl_ms": 300000, "used_in": "/api/hierarchy" }
          ],
          "stats_exposed": "/api/health"
        }
      },
      "AdminAuth": {
        "file": "lib/admin.js",
        "middlewares": [
          { "name": "requireAdmin", "rule": "if NODE_ENV=production then require ADMIN_KEY query param", "use_cases": ["debug endpoints"] },
          { "name": "requireAdminIfConfigured", "rule": "if ADMIN_KEY set then require query param always", "use_cases": ["scrape endpoints"] }
        ]
      },
      "StatsProvider": {
        "file": "lib/statsProvider.js",
        "upstream": {
          "name": "KrosStats",
          "url_pattern": "{KROSSTATS_API_BASE}/{lang}/{siteId}/{token}/Entity/GetGeneralStatsInfo?matchId={gameId}"
        },
        "method": { "name": "fetchGameStats", "needs_db_game": true }
      }
    },
    "lib": {
      "parseGamesFromData": {
        "file": "lib/parseGamesFromData.js",
        "exports": ["parseGamesFromData"],
        "role": "normalize Swarm nested maps into flat game array, attach region/competition/sport, normalize market/event objects"
      },
      "markets": {
        "file": "lib/markets.js",
        "exports": ["pickMainMarket"],
        "role": "select main market (prefers full-time, avoids excluded markets like winning margin)"
      },
      "liveStream": {
        "sse": { "file": "lib/liveStream/sse.js", "exports": ["safeWrite", "safePing"] },
        "fingerprints": { "file": "lib/liveStream/fingerprints.js", "exports": ["getGameFp", "getCountsFp", "getSportFp", "getOddsFp"] },
        "odds": { "file": "lib/liveStream/odds.js", "exports": ["getSportMainMarketTypePriority", "pickPreferredMarketFromEmbedded", "buildOddsArrFromMarket"] },
        "sportNameCache": { "file": "lib/liveStream/sportNameCache.js", "exports": ["createGetSportName"], "note": "used by routes/liveStream.js" }
      },
      "liveCounts": {
        "swarmCounts": {
          "file": "lib/liveCounts/swarmCounts.js",
          "exports": ["normalizeSwarmResponse", "extractSportsCountsFromSwarm"],
          "role": "Extracts sport counts from Swarm API responses, using recursive counting to ensure accuracy across the full hierarchy (sport/region/competition)."
        }
      },
      "scrape": {
        "sportName": { "file": "lib/scrape/sportName.js", "exports": ["resolveSportNameFromHierarchy", "normalizeSportNameFromQuery"] },
        "gameFilters": { "file": "lib/scrape/gameFilters.js", "exports": ["filterGamesByTypeParam", "filterPrematchAndOutright"] }
      }
    },
    "endpoints": [
      {
        "method": "GET",
        "path": "/api/hierarchy",
        "module": "routes/hierarchy.js",
        "handler": "registerHierarchyRoutes",
        "auth": "none",
        "cache": { "layer": "in_memory", "ttl_ms": 300000, "bypass_query": "refresh=true" },
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "getHierarchy" }],
        "returns": { "shape": "swarm_hierarchy_object", "extra_fields": ["cached:boolean"] }
      },
      {
        "method": "GET",
        "path": "/api/counts-stream",
        "module": "routes/liveCounts.js",
        "handler": "registerLiveCountRoutes",
        "type": "SSE",
        "auth": "none",
        "sse_events": [
          { "event": "live_counts", "payload": "{source,count,total_games,sports[],timestamp}" },
          { "event": "prematch_counts", "payload": "{source,count,total_games,sports[],timestamp}" },
          { "event": "comment_ping", "payload": "': ping ...' (SSE comment)" }
        ],
        "server_polling": [
          { "name": "counts_subscription_watchdog", "interval_ms": 15000, "shared_across_clients": true, "notes": "periodic refresh to avoid staleness if Swarm misses a subscription delta" },
          { "name": "counts_polling_fallback", "interval_ms": 1000, "shared_across_clients": true, "notes": "used only if Swarm @count subscriptions are unavailable" }
        ],
        "upstream_calls": [
          { "service": "Swarm", "scraper_method": "subscribeToLiveCount", "for": "lightweight @count change detector" },
          { "service": "Swarm", "scraper_method": "subscribeToPrematchCount", "for": "lightweight @count change detector" },
          { "service": "Swarm", "scraper_method": "sendRequest(get)", "for": "live counts", "where": "game.type=1" },
          { "service": "Swarm", "scraper_method": "sendRequest(get)", "for": "prematch counts", "where": "Forzza-exact filter (visible_in_prematch OR type in [0,2], sport.type not in [1,4])" }
        ],
        "diffing": [{ "level": "counts", "method": "getCountsFp" }],
        "notes": "Counts are refreshed primarily when Swarm @count subscriptions push an update (debounced); watchdog refresh runs every 15s; falls back to 1s polling if subscriptions fail. Matches Forzza's exact prematch filter for identical counts."
      },
      {
        "method": "GET",
        "path": "/api/live-sports",
        "module": "routes/liveCounts.js",
        "handler": "registerLiveCountRoutes",
        "auth": "none",
        "cache": { "layer": "in_memory", "ttl_ms": 60000 },
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "sendRequest(get)", "where": "game.type in [1]" }],
        "returns": { "shape": "{source,cached,count,total_games,sports[],timestamp}" }
      },
      {
        "method": "GET",
        "path": "/api/prematch-sports",
        "module": "routes/liveCounts.js",
        "handler": "registerLiveCountRoutes",
        "auth": "none",
        "cache": { "layer": "in_memory", "ttl_ms": 60000 },
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "sendRequest(get)", "where": "Forzza-exact filter: game.(@or:[visible_in_prematch:1, type in [0,2]]), sport.type not in [1,4]" }],
        "returns": { "shape": "{source,cached,count,total_games,sports[],timestamp}" }
      },
      {
        "method": "GET",
        "path": "/api/live-stream",
        "module": "routes/liveStream.js",
        "handler": "registerLiveStreamRoutes",
        "type": "SSE",
        "auth": "none",
        "query": [{ "name": "sportId", "required": false }],
        "sse_events": [
          { "event": "counts", "payload": "{source,count,total_games,sports[],timestamp}" },
          { "event": "games", "payload": "{sportId,sportName,count,last_updated,data:[game...]}" },
          { "event": "odds", "payload": "{sportId,sportName,server_ts,updates:[{gameId,odds[],markets_count,market{...}}...]}" },
          { "event": "error", "payload": "{error,timestamp,...}" },
          { "event": "comment_ping", "payload": "': ping ...' (SSE comment)" }
        ],
        "server_polling": [
          { "name": "counts", "interval_ms": 1000, "shared_across_clients": true },
          { "name": "sport_games_and_odds", "interval_ms": 1000, "per_sportId": true }
        ],
        "upstream_calls": [
          { "service": "Swarm", "scraper_method": "sendRequest(get)", "for": "counts" },
          { "service": "Swarm", "scraper_method": "getGamesBySport", "for": "sport games list" },
          { "service": "Swarm", "scraper_method": "sendRequest(get)", "for": "odds batch by gameIds + market types" }
        ],
        "diffing": [
          { "level": "counts", "method": "getCountsFp" },
          { "level": "sport games", "method": "getSportFp" },
          { "level": "odds per game", "method": "getOddsFp" }
        ]
      },
      {
        "method": "GET",
        "path": "/api/prematch-stream",
        "module": "routes/prematchStream.js",
        "handler": "registerPrematchStreamRoutes",
        "type": "SSE",
        "auth": "none",
        "query": [
          { "name": "sportId", "required": true },
          { "name": "sportName", "required": false }
        ],
        "sse_events": [
          { "event": "games", "payload": "{sportId,sportName,count,last_updated,data:[game...]}" },
          { "event": "odds", "payload": "{sportId,sportName,server_ts,updates:[{gameId,odds[],markets_count,market{...}}...]}" },
          { "event": "error", "payload": "{error,timestamp,...}" },
          { "event": "comment_ping", "payload": "': ping ...' (SSE comment)" }
        ],
        "server_polling": [
          { "name": "prematch_games_refresh", "interval_ms": 15000, "per_sportId": true, "notes": "refreshes cached games list if no Swarm subscription is active" },
          { "name": "prematch_main_market_odds", "interval_ms": 3000, "per_sportId": true, "notes": "batches gameIds and emits odds deltas; also sends cached odds snapshot on connect" }
        ],
        "upstream_calls": [
          { "service": "Swarm", "scraper_method": "subscribeToPrematchGames", "for": "sport games list (subscription when available)" },
          { "service": "Swarm", "scraper_method": "sendRequest(get)", "for": "odds batch by gameIds + market types" }
        ],
        "diffing": [
          { "level": "sport games", "method": "getSportFp" },
          { "level": "odds per game", "method": "getOddsFp" }
        ],
        "notes": "Server caches last odds per game to emit an odds snapshot immediately on reconnect. Server tells clients odds deltas in a single batched stream. Server caches one Swarm subscription per sportId and unsubscribes after ~60s idle (no SSE clients)."
      },
      {
        "method": "GET",
        "path": "/api/live-game-stream",
        "module": "routes/liveStream.js",
        "handler": "registerLiveStreamRoutes",
        "type": "SSE",
        "auth": "none",
        "query": [{ "name": "gameId", "required": true }],
        "sse_events": [
          { "event": "game", "payload": "{gameId,server_ts,data:{market:{...}}}" },
          { "event": "error", "payload": "{gameId,error,timestamp}" },
          { "event": "comment_ping", "payload": "': ping ...' (SSE comment)" }
        ],
        "server_polling": [{ "name": "game markets polling fallback", "interval_ms": 1000, "per_gameId": true, "notes": "used only if Swarm subscription cannot be created" }],
        "upstream_calls": [
          { "service": "Swarm", "scraper_method": "subscribeToGameMarkets", "for": "market+event by gameId (subscribe:true)" },
          { "service": "Swarm", "scraper_method": "sendRequest(get)", "for": "market+event by gameId (fallback)" }
        ],
        "diffing": [{ "level": "game markets", "method": "getGameFp" }]
      },
      {
        "method": "GET",
        "path": "/api/game-main-market",
        "module": "routes/markets.js",
        "handler": "registerMarketRoutes",
        "auth": "none",
        "query": [{ "name": "gameId", "required": true }],
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "sendRequest(get)", "for": "market+event by gameId" }],
        "processing": [
          { "step": "unwrapSwarmData", "file": "lib/swarm/unwrap.js" },
          { "step": "pickMainMarket", "file": "lib/markets.js" }
        ],
        "returns": {
          "shape": "{gameId,server_ts,markets_count,picked_market,market}",
          "notes": "market may be null if no acceptable main market; legacy endpoint (frontend no longer calls it)"
        }
      },
      {
        "method": "GET",
        "path": "/api/game-details",
        "module": "routes/markets.js",
        "handler": "registerMarketRoutes",
        "auth": "none",
        "query": [{ "name": "gameId", "required": true }],
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "sendRequest(get)", "for": "market+event by gameId" }],
        "returns": { "shape": "unwrapped_swarm_market_event_maps", "notes": "legacy endpoint (frontend uses /api/live-game-stream instead)" }
      },
      {
        "method": "GET",
        "path": "/api/cached-sports",
        "module": "routes/cached.js",
        "handler": "registerCachedRoutes",
        "auth": "none",
        "requires": ["MONGODB_URI"],
        "db_calls": [{ "model": "Game", "via": "QueryOptimizer.getLatestCountsBySport", "match": "type in [0,2]" }],
        "returns": { "shape": "{source:'mongodb',count,total_games,sports[]}" }
      },
      {
        "method": "GET",
        "path": "/api/sport-games",
        "module": "routes/cached.js",
        "handler": "registerCachedRoutes",
        "auth": "none",
        "requires": ["MONGODB_URI"],
        "query": [
          { "name": "sportName", "required": true },
          { "name": "limit", "required": false },
          { "name": "skip", "required": false },
          { "name": "all", "required": false },
          { "name": "maxDocs", "required": false }
        ],
        "db_calls": [
          { "step": "findExactSportName", "via": "QueryOptimizer.findExactSportName" },
          { "step": "getLatestGamesBySport or getAllLatestGamesBySport", "via": "QueryOptimizer.*", "match": "type in [0,2]" }
        ],
        "returns": {
          "shape": "{source:'mongodb',sport,last_updated,pagination,count,data:[games]}",
          "notes": "in all=true mode returns returned_count + truncated"
        }
      },
      {
        "method": "GET",
        "path": "/api/football-games",
        "module": "routes/cached.js",
        "handler": "registerCachedRoutes",
        "auth": "none",
        "requires": ["MONGODB_URI"],
        "db_calls": [{ "via": "QueryOptimizer.getLatestGamesBySport", "sport": "Football", "match": "type in [0,2]" }],
        "returns": { "shape": "{source:'mongodb',sport,last_updated,pagination,count,data}" }
      },
      {
        "method": "GET",
        "path": "/api/sport-full-scrape",
        "module": "routes/scrape.js",
        "handler": "registerScrapeRoutes",
        "auth": { "type": "query_key_optional", "middleware": "requireAdminIfConfigured" },
        "query": [
          { "name": "sportId", "required": true },
          { "name": "sportName", "required": true },
          { "name": "type", "required": false, "values": ["live", "prematch", "all"] }
        ],
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "getGamesBySport" }],
        "processing": [
          { "step": "resolveSportNameFromHierarchy", "file": "lib/scrape/sportName.js" },
          { "step": "parseGamesFromData", "file": "lib/parseGamesFromData.js" },
          { "step": "filterGamesByTypeParam", "file": "lib/scrape/gameFilters.js" }
        ],
        "persistence": {
          "writes_mongo": "only when type is missing or 'prematch' (per current implementation)",
          "via": "lib/saveSportData.js -> QueryOptimizer.bulkUpsertGames"
        },
        "returns": { "shape": "{message,count,last_updated,data:[games],diagnostics?}" }
      },
      {
        "method": "GET",
        "path": "/api/fetch-all-sports",
        "module": "routes/scrape.js",
        "handler": "registerScrapeRoutes",
        "auth": { "type": "query_key_optional", "middleware": "requireAdminIfConfigured" },
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "getHierarchy" }],
        "processing": [
          { "step": "RateLimitedScraper.scrapeAll", "file": "utils/RateLimitedScraper.js" },
          { "step": "parseGamesFromData", "file": "lib/parseGamesFromData.js" },
          { "step": "filterPrematchAndOutright", "file": "lib/scrape/gameFilters.js" }
        ],
        "persistence": { "writes_mongo": true, "via": "QueryOptimizer.bulkUpsertGames" },
        "returns": { "shape": "{message,summary[],errors[],progress,count,timestamp}" }
      },
      {
        "method": "GET",
        "path": "/api/football-full-scrape",
        "module": "routes/scrape.js",
        "handler": "registerScrapeRoutes",
        "auth": { "type": "query_key_optional", "middleware": "requireAdminIfConfigured" },
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "getGamesBySport", "sportId": 1 }],
        "processing": [
          { "step": "parseGamesFromData", "file": "lib/parseGamesFromData.js" },
          { "step": "filterPrematchAndOutright", "file": "lib/scrape/gameFilters.js" }
        ],
        "persistence": { "writes_mongo": true },
        "returns": { "shape": "{message,count,last_updated,data:[games]}" }
      },
      {
        "method": "GET",
        "path": "/api/game-stats",
        "module": "routes/stats.js",
        "handler": "registerStatsRoutes",
        "auth": "none",
        "query": [{ "name": "gameId", "required": true }],
        "db_calls": [{ "model": "Game", "via": "Game.findOne({gameId})" }],
        "upstream_calls": [{ "service": "KrosStats", "via": "axios.get(statsUrl)" }],
        "returns": { "shape": "{gameId,stats:{home,away,raw}}" }
      },
      {
        "method": "GET",
        "path": "/api/live-tracker",
        "module": "routes/liveTracker.js",
        "handler": "registerLiveTrackerRoutes",
        "type": "SSE",
        "auth": "none",
        "query": [{ "name": "gameId", "required": true }],
        "upstream_calls": [
          {
            "service": "Animation WS",
            "ws_url": "wss://animation.ml.bcua.io/animation_json_v2?partner_id=1777&site_ref=https://sportsbook.forzza1x2.com/",
            "subscribe_message": "request.arg.submatch{feed_type:'live', gameevents:'true', id:gameId, snapshot:true}"
          }
        ],
        "sse_events": [
          { "event": "ready", "payload": "{gameId}" },
          { "event": "message", "payload": "raw upstream JSON" },
          { "event": "error", "payload": "{error,...}" },
          { "event": "end", "payload": "{gameId}" },
          { "event": "comment_ping", "payload": "': ping ...' (SSE comment)" }
        ]
      },
      {
        "method": "GET",
        "path": "/api/health",
        "module": "routes/health.js",
        "handler": "registerHealthRoutes",
        "auth": "none",
        "returns": { "shape": "{status,uptime,cache:{hits,misses,size},responseTime:{avg,p95,slowRequests},counts_stream:{runs_last_60s,runs_by_reason,last_reason,last_run_at,...},swarm_ws:{connected,session_id,ws_url,ws_messages_total,ws_messages_last_60s,ws_parse_errors_total,ws_messages_by_kind,active_subscriptions,updates_last_60s_total,by_endpoint,by_tag,subscriptions:[{subid,endpoint,tag,extra,created_at,last_update_at,updates_total,updates_last_60s,...}]}}" }
      },
      {
        "method": "GET",
        "path": "/api/debug-market-fields",
        "module": "routes/debug.js",
        "handler": "registerDebugRoutes",
        "auth": { "type": "admin_only", "middleware": "requireAdmin (only enforced in production)" },
        "query": [{ "name": "gameId", "required": true }],
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "sendRequest(get)", "what": "market:[],event:[]" }],
        "returns": { "shape": "{totalMarkets,marketFields,sampleMarket,eventFields,sampleEvent,blockedMarkets,blockedEvents}" }
      },
      {
        "method": "GET",
        "path": "/api/debug-game-fields",
        "module": "routes/debug.js",
        "handler": "registerDebugRoutes",
        "auth": "none (per comment in file)",
        "query": [{ "name": "gameId", "required": false }, { "name": "sportId", "required": false }],
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "sendRequest(get)", "what": "game:[]" }],
        "returns": { "shape": "{totalGames,sampleGameFields,sampleGame,infoFields,statsFields,rawDataKeys}" }
      },
      {
        "method": "GET",
        "path": "/api/debug-games",
        "module": "routes/debug.js",
        "handler": "registerDebugRoutes",
        "auth": { "type": "admin_only", "middleware": "requireAdmin (only enforced in production)" },
        "query": [{ "name": "sportId", "required": false }],
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "init + sendRequest(get)" }],
        "returns": { "shape": "{sessionId,gameTypeDistribution,totalGames,competitionsByType,rawDataKeys,rawResponseKeys}" }
      },
      {
        "method": "GET",
        "path": "/api/results/competitions",
        "module": "routes/results.js",
        "handler": "registerResultsRoutes",
        "auth": "none",
        "query": [
          { "name": "from", "required": false, "description": "Unix timestamp start (defaults to today)" },
          { "name": "to", "required": false, "description": "Unix timestamp end (defaults to today)" }
        ],
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "getActiveCompetitions" }],
        "returns": { "shape": "{success,data:[{Id,Name,Alias,Regions:[{Id,Name,Competitions:[...]}]}],timestamp}" }
      },
      {
        "method": "GET",
        "path": "/api/results/games/:sportId",
        "module": "routes/results.js",
        "handler": "registerResultsRoutes",
        "auth": "none",
        "params": [{ "name": "sportId", "required": true, "description": "Sport ID (1=Football, 2=Ice Hockey, etc.)" }],
        "query": [
          { "name": "from", "required": false, "description": "Unix timestamp start (defaults to today)" },
          { "name": "to", "required": false, "description": "Unix timestamp end (defaults to today)" }
        ],
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "getResultGames" }],
        "returns": { "shape": "{success,sportId,count,games:[{game_id,game_name,scores,team1_name,team2_name,competition_name,region_name,date}],timestamp}" }
      },
      {
        "method": "GET",
        "path": "/api/results/game/:gameId",
        "module": "routes/results.js",
        "handler": "registerResultsRoutes",
        "auth": "none",
        "params": [{ "name": "gameId", "required": true }],
        "upstream_calls": [{ "service": "Swarm", "scraper_method": "getGameResults" }],
        "returns": { "shape": "{success,gameId,settlements:[{market,winners:[]}],raw,timestamp}" }
      }
    ]
  },
  "frontend": {
    "entry": {
      "file": "public/index.html",
      "scripts_in_order": [
        "js/state.js",
        "js/dom.js",
        "js/mobile.js",
        "js/ui.js",
        "js/markets.js",
        "js/mainMarketHydration.js",
        "js/renderGames/liveMeta.js",
        "js/renderGames/virtualization.js",
        "js/renderGames/treeState.js",
        "js/renderGames/gameRows.js",
        "js/renderGames/treeRender.js",
        "js/utils/json.js",
        "js/api/state.js",
        "js/api/liveGameStream.js",
        "js/api/livePayloads.js",
        "js/api/liveFallbackPolling.js",
        "js/api/liveStream.js",
        "js/api/countsStream.js",
        "js/api/healthActions.js",
        "js/api/sports.js",
        "js/api/games.js",
        "js/api/results.js",
        "js/renderSports.js",
        "js/renderGames.js",
        "js/details/state.js",
        "js/details/liveTracker.js",
        "js/details/stats.js",
        "js/details/markets.js",
        "js/details/uiState.js",
        "js/details/bindings.js",
        "js/details.js",
        "js/health.js",
        "js/events.js"
      ]
    },
    "globals": {
      "core_state": [
        "hierarchy",
        "currentSport",
        "currentGames",
        "selectedGame",
        "currentMode",
        "cachedMode",
        "sportsWithCachedGames",
        "sportsWithPrematchGames",
        "sportsWithLiveGames",
        "sportsWithResults",
        "sportsCountsCached",
        "sportsCountsPrematch",
        "sportsCountsLive",
        "sportsCountsResults",
        "totalGamesCached",
        "totalGamesPrematch",
        "totalGamesLive",
        "totalGamesResults"
      ],
      "live_stream_state": [
        "liveStreamSource",
        "liveStreamSportId",
        "liveStreamHasOddsSse",
        "liveStreamRetryTimeoutId",
        "liveStreamOddsIntervalId",
        "liveStreamDetailsIntervalId"
      ],
      "live_game_stream_state": [
        "liveGameSource",
        "liveGameId",
        "liveGameRetryTimeoutId"
      ],
      "details_state": [
        "liveTrackerSource",
        "liveTrackerCurrentGameId"
      ]
    },
    "functions": {
      "api": [
        { "name": "loadHierarchy", "file": "public/js/api/sports.js", "calls": ["/api/hierarchy"] },
        { "name": "ensureLiveSportsLoaded", "file": "public/js/api/sports.js", "calls": ["/api/live-sports"] },
        { "name": "ensurePrematchSportsLoaded", "file": "public/js/api/sports.js", "calls": ["/api/prematch-sports"] },
        { "name": "ensureCachedSportsLoaded", "file": "public/js/api/sports.js", "calls": ["/api/cached-sports"] },
        { "name": "ensureResultsSportsLoaded", "file": "public/js/api/results.js", "calls": ["/api/results/competitions"] },
        { "name": "loadGames", "file": "public/js/api/games.js", "calls": ["/api/sport-full-scrape", "/api/sport-games"] },
        { "name": "startPrematchStream", "file": "public/js/api/prematchStream.js", "calls": ["/api/prematch-stream (SSE)"] },
        { "name": "stopPrematchStream", "file": "public/js/api/prematchStream.js", "calls": [] },
        { "name": "loadResultGames", "file": "public/js/api/results.js", "calls": ["/api/results/games/:sportId"] },
        { "name": "loadGameSettlements", "file": "public/js/api/results.js", "calls": ["/api/results/game/:gameId"] },
        { "name": "refreshCurrentSportPrematchGames", "file": "public/js/api/games.js", "calls": ["/api/sport-full-scrape"] },
        { "name": "startLiveStream", "file": "public/js/api/liveStream.js", "calls": ["/api/live-stream (SSE)"] },
        { "name": "stopLiveStream", "file": "public/js/api/liveStream.js", "calls": [] },
        { "name": "startLiveGameStream", "file": "public/js/api/liveGameStream.js", "calls": ["/api/live-game-stream (SSE)"] },
        { "name": "stopLiveGameStream", "file": "public/js/api/liveGameStream.js", "calls": [] },
        { "name": "applyLiveCountsPayload", "file": "public/js/api/livePayloads.js", "calls": ["renderSportsList", "updateModeButtons"] },
        { "name": "applyLiveGamesPayload", "file": "public/js/api/livePayloads.js", "calls": ["renderGames", "snapshotRegionsTreeState", "scheduleVirtualUpdate"] },
        { "name": "applyLiveOddsPayload", "file": "public/js/api/livePayloads.js", "calls": ["updateGameRowOdds"] },
        { "name": "applyPrematchCountsPayload", "file": "public/js/api/livePayloads.js", "calls": ["updateModeButtons", "renderSportsList"] },
        { "name": "startCountsStream", "file": "public/js/api/countsStream.js", "calls": ["/api/counts-stream (SSE)"] },
        { "name": "stopCountsStream", "file": "public/js/api/countsStream.js", "calls": [] }
      ],
      "rendering": [
        { "name": "renderSportsList", "file": "public/js/renderSports.js", "role": "sidebar list renderer" },
        { "name": "renderGames", "file": "public/js/renderGames.js", "role": "top-level games view renderer" },
        { "name": "renderResultGames", "file": "public/js/api/results.js", "role": "results mode games renderer with scores" },
        { "name": "renderResultsTree", "file": "public/js/api/results.js", "role": "region/competition tree for results" },
        { "name": "showResultDetails", "file": "public/js/api/results.js", "role": "display market settlements in details panel" },
        { "name": "renderRegionsTree", "file": "public/js/renderGames/treeRender.js", "role": "region/competition DOM + virtualization hooks" },
        { "name": "renderGamesInCompetition", "file": "public/js/renderGames/gameRows.js", "role": "row HTML generation including odds + live meta" },
        { "name": "scheduleVirtualUpdate", "file": "public/js/renderGames/virtualization.js", "role": "windowing update scheduler" }
      ],
      "odds_and_markets": [
        { "name": "pickMainMarketFromMap", "file": "public/js/markets.js", "role": "client-side main market selection" },
        { "name": "extract1X2Odds", "file": "public/js/markets.js", "role": "normalize odds labels and blocked status" },
        { "name": "updateGameRowOdds", "file": "public/js/mainMarketHydration.js", "role": "DOM patch odds buttons for a row" },
        { "name": "hydrateMainMarketsInContainer", "file": "public/js/mainMarketHydration.js", "role": "Disabled (no-op). Frontend no longer fetches /api/game-main-market." }
      ],
      "details": [
        { "name": "showGameDetails", "file": "public/js/details.js", "role": "render details panel; relies on /api/live-game-stream to populate markets if missing" },
        { "name": "clearGameDetails", "file": "public/js/details.js", "role": "reset details UI and stop live streams" },
        { "name": "snapshotDetailsUiStateFromDom", "file": "public/js/details/uiState.js", "role": "persist active tab, expanded/collapsed, scrollTop" },
        { "name": "restoreDetailsScrollFromState", "file": "public/js/details/uiState.js", "role": "restore scrollTop" },
        { "name": "bindDetailsScrollPersist", "file": "public/js/details/uiState.js", "role": "write scrollTop as user scrolls" }
      ],
      "event_loop": [
        {
          "name": "setupEventListeners",
          "file": "public/js/events.js",
          "role": "hooks UI actions, starts polling, starts keep-alive, bootstraps app"
        }
      ]
    }
  },
  "data_flow": {
    "entities": {
      "Game": {
        "server_id": "id or gameId",
        "client_id": "__clientId",
        "fields": [
          "team1_name",
          "team2_name",
          "start_ts",
          "type",
          "is_blocked",
          "markets_count",
          "info",
          "text_info",
          "market{marketId -> market{event{eventId->event}}}"
        ],
        "client_side_ephemeral_fields": [
          "__mainOdds",
          "__mainMarketsCount",
          "__mainOddsFlash",
          "__mainOddsUpdatedAt",
          "__marketFetchStarted",
          "__activeTab",
          "__detailsUiState",
          "__prevEventPrices"
        ]
      }
    },
    "flows": [
      {
        "name": "app_bootstrap",
        "trigger": "DOMContentLoaded",
        "frontend_steps": [
          { "fn": "loadHierarchy", "calls": "/api/hierarchy" },
          { "fn": "loadHealth", "calls": "/api/health" },
          { "fn": "setupEventListeners", "starts": ["prematch polling", "mode handlers", "search handlers"] },
          { "fn": "startCountsStream", "opens": "/api/counts-stream (SSE)", "effects": ["real-time live/prematch counts"] }
        ],
        "backend_steps": [
          { "fn": "register routes", "file": "index.js" }
        ]
      },
      {
        "name": "prematch_mode_view",
        "trigger": "user selects Prematch and chooses sport",
        "frontend_steps": [
          { "fn": "setMode('prematch')", "effects": ["stopLiveStream if running", "renderSportsList", "clear games UI"] },
          { "fn": "ensurePrematchSportsLoaded", "calls": "/api/prematch-sports" },
          { "fn": "startPrematchStream", "opens": "/api/prematch-stream?sportId=..." },
          { "event": "games", "handler": "applyPrematchGamesPayload -> renderGames (preserve tree state and scroll)" },
          { "event": "odds", "handler": "applyLiveOddsPayload -> updateGameRowOdds (DOM patch)" },
          { "fallback": "legacy row hydration", "effects": ["none"], "notes": "frontend no longer hydrates rows via /api/game-main-market" }
        ],
        "backend_steps": [
          { "fn": "routes/prematch-stream", "calls": ["ensureCachedData", "subscribeToPrematchGames (if available)"] },
          { "fn": "prematch odds polling", "calls": ["batch main market odds by gameIds", "emit odds deltas"], "notes": "caches last odds per game and emits an odds snapshot on connect" }
        ]
      },
      {
        "name": "cached_mode_view",
        "trigger": "user selects Cached and chooses sport",
        "frontend_steps": [
          { "fn": "setMode('cached')", "effects": ["stopLiveStream", "renderSportsList", "clear games UI"] },
          { "fn": "ensureCachedSportsLoaded", "calls": "/api/cached-sports" },
          { "fn": "loadGames", "calls": "/api/sport-games (paginated, up to 20 pages x 500)" },
          { "fn": "renderGames + virtualization", "effects": ["render games list"] }
        ],
        "backend_steps": [
          { "fn": "routes/cached.sport-games", "db": ["QueryOptimizer.findExactSportName", "QueryOptimizer.getLatestGamesBySport|getAllLatestGamesBySport"] }
        ]
      },
      {
        "name": "live_mode_counts_and_sport_stream",
        "trigger": "user selects Live and optionally chooses sport",
        "frontend_steps": [
          { "fn": "setMode('live')", "effects": ["startLiveStream(null)"] },
          { "fn": "startLiveStream(sportId|null)", "opens": "/api/live-stream?sportId=..." },
          { "event": "counts", "handler": "applyLiveCountsPayload -> renderSportsList/updateModeButtons" },
          { "event": "games", "handler": "applyLiveGamesPayload -> renderGames (preserve details state and scroll)" },
          { "event": "odds", "handler": "applyLiveOddsPayload -> updateGameRowOdds (DOM patch)" },
          { "fallback": "EventSource error", "effects": ["toast", "retry SSE", "poll odds/selected game as fallback"] }
        ],
        "backend_steps": [
          { "poll": "counts every 1s", "calls": "scraper.sendRequest(get: sport+game, where type=1)" },
          { "poll": "sport games every 1s (per sportId)", "calls": "scraper.getGamesBySport(sportId) -> parseGamesFromData -> filter type=1" },
          { "poll": "sport odds batch every 1s (per sportId)", "calls": "scraper.sendRequest(get: game+market+event, where gameId in [...], market.type in priority list)" },
          { "diff": "fingerprint compare", "emits": "only changed payloads" }
        ]
      },
      {
        "name": "live_mode_selected_game_sync",
        "trigger": "user clicks a live game row while in live mode",
        "frontend_steps": [
          { "fn": "selectGame", "effects": ["selectedGame set", "startLiveGameStream(gameId)", "showGameDetails"] },
          { "fn": "startLiveGameStream", "opens": "/api/live-game-stream?gameId=..." },
          {
            "event": "game",
            "effects": [
              "selectedGame.market updated from payload.data.market",
              "updateGameRowOdds(serverGameId, extractedOdds, marketsCount)",
              "showGameDetails(selectedGame) re-render (preserving UI state)"
            ]
          }
        ],
        "backend_steps": [
          { "subscribe": "game markets", "calls": "scraper.subscribeToGameMarkets(gameId)" },
          { "poll": "game markets every 1s (fallback)", "calls": "scraper.sendRequest(get markets+events by gameId)", "notes": "only if subscription fails" },
          { "diff": "getGameFp", "emits": "game event only when changed" }
        ]
      },
      {
        "name": "details_panel_market_fetch",
        "trigger": "details opened but game.market missing",
        "frontend_steps": [
          { "fn": "showGameDetails", "detects": "no markets", "calls": "/api/live-game-stream?gameId=... (SSE)" },
          { "event": "game", "effects": ["market stored on game", "showGameDetails re-render"] }
        ],
        "backend_steps": [{ "fn": "/api/live-game-stream", "calls": ["scraper.subscribeToGameMarkets (preferred)", "scraper.sendRequest(get markets+events) (fallback)"] }]
      },
      {
        "name": "live_tracker_stream",
        "trigger": "details for live game rendered",
        "frontend_steps": [
          { "fn": "ensureLiveTracker", "opens": "/api/live-tracker?gameId=..." },
          { "event": "ready/message/error/end", "effects": "update tracker UI/iframe or stream state" }
        ],
        "backend_steps": [
          { "fn": "/api/live-tracker", "opens_ws": "animation.ml.bcua.io", "relays": "ws messages to SSE" }
        ]
      },
      {
        "name": "results_mode_view",
        "trigger": "user selects Results and chooses sport",
        "frontend_steps": [
          { "fn": "setMode('results')", "effects": ["stopLiveStream", "renderSportsList", "clear games UI"] },
          { "fn": "ensureResultsSportsLoaded", "calls": "/api/results/competitions" },
          { "fn": "loadResultGames", "calls": "/api/results/games/:sportId" },
          { "fn": "renderResultGames -> renderResultsTree", "effects": ["display finished games with scores grouped by region/competition"] }
        ],
        "backend_steps": [
          { "fn": "routes/results.competitions", "calls": "scraper.getActiveCompetitions" },
          { "fn": "routes/results.games", "calls": "scraper.getResultGames" }
        ]
      },
      {
        "name": "results_mode_game_details",
        "trigger": "user clicks a finished game row in results mode",
        "frontend_steps": [
          { "fn": "showResultDetails", "calls": "/api/results/game/:gameId" },
          { "fn": "render settlements", "effects": ["display market settlements with winning selections in details panel"] }
        ],
        "backend_steps": [
          { "fn": "routes/results.game", "calls": "scraper.getGameResults" }
        ]
      }
    ]
  }
}
